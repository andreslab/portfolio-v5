name: Deploy Porfolio

on:
  push:
    branches:
      - demo

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      PORT_APP: 80
      PORT_OUTSIDE: 8888
      CONTAINER_NAME: 'FRONTEND-CV'
      IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/frontend-cv
      IMAGE_TAG: latest

    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.19.0
          # flutter-version-file: pubspec.yaml # path to pubspec.yaml
      - run: flutter --version

      - name: Enable Flutter Web
        run: flutter config --enable-web

      # - name: Run Tests
        # run: flutter test

      - name: Download Dependencies
        run: flutter pub get

      - name: Build
        run: flutter build web

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./build/web
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/backend-farm:latest

      - name: executing remote ssh commands using password
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            docker stop ${{ env.CONTAINER_NAME }} || true
            docker rm ${{ env.CONTAINER_NAME }} || true
            docker rmi ${{ env.IMAGE_NAME }}:legacy || true
            docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} ${{ env.IMAGE_NAME }}:legacy || true
            docker pull ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            docker run -d --name ${{ env.CONTAINER_NAME }} -p ${{ env.PORT_OUTSIDE }}:${{ env.PORT_APP }} -e PORT=${{ env.PORT_APP }} ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}